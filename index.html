<!DOCTYPE html>
<html>
<head>
  <title>Atidaryti AplankƒÖ</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
window.TrelloPowerUp.initialize({
  'card-buttons': function(t) {
    return t.card('desc', 'checklists', 'actions')
      .get('desc', 'checklists', 'actions')
      .then(function(card) {
        const buttons = [];

        // ----------- 1. Apra≈°ymo analizƒó ------------
        extractLinksFromText(card.desc, buttons);

        // ----------- 2. Checklist analizƒó ------------
        if (card.checklists) {
          card.checklists.forEach(cl => {
            cl.checkItems.forEach(item => {
              extractLinksFromText(item.name, buttons);
            });
          });
        }

        // ----------- 3. Komentar≈≥ analizƒó ------------
        if (card.actions) {
          card.actions.forEach(action => {
            if (action.type === 'commentCard' && action.data.text) {
              extractLinksFromText(action.data.text, buttons);
            }
          });
        }

        return buttons;
      });
  }
});

// üîç I≈°traukimo funkcija
function extractLinksFromText(text, buttonsArray) {
  const lines = text.split(/\r?\n/);

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    if (line.startsWith('`open-folder://') && line.endsWith('`')) {
      const rawPath = line.slice(1, -1).replace(/\\/g, '/');

      // Paie≈°ka vir≈°uje esanƒçio pavadinimo **Pavadinimas:**
      let label = 'Atidaryti aplankƒÖ';
      for (let j = i - 1; j >= 0; j--) {
        const prevLine = lines[j].trim();
        const match = /^\*\*(.+?)\*\*[:]?$/.exec(prevLine);
        if (match) {
          label = match[1].trim();
          break;
        }
      }

      buttonsArray.push({
        icon: 'https://cdn-icons-png.flaticon.com/512/716/716784.png',
        text: label,
        callback: function(t) {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = rawPath;
          document.body.appendChild(iframe);
          return t.closePopup();
        }
      });
    }
  }
}
</script>
</body>
</html>
