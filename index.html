<!DOCTYPE html>
<html>
<head>
  <title>Atidaryti Aplanką</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
window.TrelloPowerUp.initialize({
  'card-buttons': function(t) {
    return t.card('desc', 'checklists', 'actions')
      .get('desc', 'checklists', 'actions')
      .then(function(card) {
      // .then(function(desc) {
        // if (!desc) return [];
        // const lines = desc.split(/\r?\n/);
        const buttons = [];

        // ----------- 1. Aprašymo analizė ------------
        extractLinksFromText(card.desc, buttons);

        // ----------- 2. Checklist analizė ------------
        if (card.checklists) {
          card.checklists.forEach(cl => {
            cl.checkItems.forEach(item => {
              extractLinksFromText(item.name, buttons);
            });
          });
        }

        // ----------- 3. Komentarų analizė ------------
        if (card.actions) {
          card.actions.forEach(action => {
            if (action.type === 'commentCard' && action.data.text) {
              extractLinksFromText(action.data.text, buttons);
            }
          });
        }

        return buttons;
      });
  }
});

for (let i = 0; i < lines.length; i++) {
  const line = lines[i].trim();

  // Jei tai yra `open-folder://` eilutė
  if (line.startsWith('`open-folder://') && line.endsWith('`')) {
    // Pašalinti `` simbolius ir pakeisti \ į /
    const rawPath = line.slice(1, -1).replace(/\\/g, '/');

    // Ieškome viršuje esančio **Pavadinimo:**
    let label = 'Atidaryti aplanką';
    for (let j = i - 1; j >= 0; j--) {
      const prevLine = lines[j].trim();
      const match = /^\*\*(.+?)\*\*[:]?$/.exec(prevLine);
      if (match) {
        label = match[1].trim();
        break;
      }
    }

    buttons.push({
      icon: 'https://cdn-icons-png.flaticon.com/512/716/716784.png',
      text: label,
      callback: function(t) {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = rawPath;
        document.body.appendChild(iframe);
        return t.closePopup();
      }
    });
  }
}

//         return buttons;
//       });
//   }
// });
</script>
</body>
</html>
