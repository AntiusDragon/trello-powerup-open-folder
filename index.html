<!DOCTYPE html>
<html>
<head>
  <title>Atidaryti Aplanką</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  const extractLinksFromText = (text, buttonsArray) => {
    if (!text) return;

    const lines = text.split(/\r?\n/);
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();

      const folderMatch = line.match(/^`(open-folder:\/\/[^`]+)`$/);
      if (folderMatch) {
        const rawPath = folderMatch[1].replace(/\\/g, '/');

        // Paieška pavadinimo virš šios eilutės
        let label = 'Atidaryti aplanką';
        for (let j = i - 1; j >= 0; j--) {
          const prevLine = lines[j].trim();
          const nameMatch = prevLine.match(/^\*\*(.+?)\*\*:?$/);
          if (nameMatch) {
            label = nameMatch[1].trim();
            break;
          }
        }

        buttonsArray.push({
          icon: 'https://cdn-icons-png.flaticon.com/512/716/716784.png',
          text: label,
          callback: function(t) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = rawPath;
            document.body.appendChild(iframe);
            return t.closePopup();
          }
        });
      }
    }
  };

  window.TrelloPowerUp.initialize({
    'card-buttons': function(t) {
      return t.card('desc', 'checklists', 'actions')
        .get('desc', 'checklists', 'actions')
        .then(function(card) {
          const buttons = [];

          // Iš aprašymo
          extractLinksFromText(card.desc, buttons);

          // Iš checklistų
          if (card.checklists) {
            card.checklists.forEach(cl => {
              cl.checkItems.forEach(item => {
                extractLinksFromText(item.name, buttons);
              });
            });
          }

          // Iš komentarų
          if (card.actions) {
            card.actions.forEach(action => {
              if (action.type === 'commentCard') {
                extractLinksFromText(action.data.text, buttons);
              }
            });
          }

          return buttons;
        });
    }
  });
</script>
</body>
</html>
